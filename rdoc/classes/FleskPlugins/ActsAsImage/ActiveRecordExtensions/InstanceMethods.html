<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Module: FleskPlugins::ActsAsImage::ActiveRecordExtensions::InstanceMethods</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../../../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Module</strong></td>
          <td class="class-name-in-header">FleskPlugins::ActsAsImage::ActiveRecordExtensions::InstanceMethods</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../../../files/lib/acts_as_image_active_record_extensions_rb.html">
                lib/acts_as_image_active_record_extensions.rb
                </a>
        <br />
            </td>
        </tr>

        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <p>
Methods in this module are added as instance methods to the model class.
</p>
<p>
About paths: There&#8217;s two different paths, the <tt><a
href="InstanceMethods.html#M000014">read_path</a></tt> and the <tt><a
href="InstanceMethods.html#M000018">save_path</a></tt>. The former is the
public path, by which the image will be reachable from the outside world,
and the latter is the server path where Rails can write or read the files.
Each image also has its own sub-path in order to prevent having all the
files in one directory, so the complete path to an image would be something
like
</p>
<p>
<tt>images/uploads/1/2/34567890abcdef/large.jpg</tt> (<a
href="InstanceMethods.html#M000017">read_path_with_filename</a>(&#8216;large&#8217;))
<tt>RAILS_ROOT/public/images/uploads/1/2/34567890abcdef/large.jpg</tt> (<a
href="InstanceMethods.html#M000021">save_path_with_filename</a>(&#8216;large&#8217;))
</p>
<p>
The <tt>url</tt> method adds a / to <tt><a
href="InstanceMethods.html#M000017">read_path_with_filename</a></tt>.
</p>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000024">delete_files</a>&nbsp;&nbsp;
      <a href="#M000011">extension</a>&nbsp;&nbsp;
      <a href="#M000010">filename</a>&nbsp;&nbsp;
      <a href="#M000022">generate_hash_string</a>&nbsp;&nbsp;
      <a href="#M000009">path</a>&nbsp;&nbsp;
      <a href="#M000023">process_image</a>&nbsp;&nbsp;
      <a href="#M000014">read_path</a>&nbsp;&nbsp;
      <a href="#M000015">read_path=</a>&nbsp;&nbsp;
      <a href="#M000017">read_path_with_filename</a>&nbsp;&nbsp;
      <a href="#M000016">read_path_with_own_path</a>&nbsp;&nbsp;
      <a href="#M000018">save_path</a>&nbsp;&nbsp;
      <a href="#M000019">save_path=</a>&nbsp;&nbsp;
      <a href="#M000021">save_path_with_filename</a>&nbsp;&nbsp;
      <a href="#M000020">save_path_with_own_path</a>&nbsp;&nbsp;
      <a href="#M000012">sizes</a>&nbsp;&nbsp;
      <a href="#M000013">sizes=</a>&nbsp;&nbsp;
      <a href="#M000008">url</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">





      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000011" class="method-detail">
        <a name="M000011"></a>

        <div class="method-heading">
          <a href="#M000011" class="method-signature">
          <span class="method-name">extension</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Determine the extension for this image. All images are saved as either JPEG
or GIF, depending on if the uploaded image is an animation or not.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000011-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000011-source">
<pre>
     <span class="ruby-comment cmt"># File lib/acts_as_image_active_record_extensions.rb, line 135</span>
135:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">extension</span>
136:           <span class="ruby-identifier">content_type</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'image/gif'</span> <span class="ruby-operator">?</span> <span class="ruby-value str">'gif'</span> <span class="ruby-operator">:</span> <span class="ruby-value str">'jpg'</span>
137:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000010" class="method-detail">
        <a name="M000010"></a>

        <div class="method-heading">
          <a href="#M000010" class="method-signature">
          <span class="method-name">filename</span><span class="method-args">(size = nil, ext = nil)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns a filename for a given size and extension. The extension will be
added automatically if not given. (It&#8217;s going to be either
&#8216;jpg&#8217; or &#8216;gif&#8217;)
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000010-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000010-source">
<pre>
     <span class="ruby-comment cmt"># File lib/acts_as_image_active_record_extensions.rb, line 125</span>
125:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">filename</span>(<span class="ruby-identifier">size</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">ext</span> = <span class="ruby-keyword kw">nil</span>)
126:           <span class="ruby-identifier">size</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">sizes</span>.<span class="ruby-identifier">keys</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">to_s</span>
127:           <span class="ruby-identifier">ext</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">extension</span>
128:           <span class="ruby-node">&quot;#{size}.#{ext}&quot;</span>
129:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000009" class="method-detail">
        <a name="M000009"></a>

        <div class="method-heading">
          <a href="#M000009" class="method-signature">
          <span class="method-name">path</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Each image has its own path inside of the <a
href="InstanceMethods.html#M000018">save_path</a>. It is made up of a hash
that is split up in three parts to prevent hitting file system limits on
the number of files allowed in one directory. The images with the names and
sizes specified in <tt>sizes</tt> are written to this directory.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000009-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000009-source">
<pre>
     <span class="ruby-comment cmt"># File lib/acts_as_image_active_record_extensions.rb, line 116</span>
116:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">path</span>
117:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">hash_string</span>.<span class="ruby-identifier">blank?</span>
118:           <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-operator">*</span><span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">hash_string</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp re">/(.)(.)(.*)/</span>).<span class="ruby-identifier">flatten</span>)
119:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000014" class="method-detail">
        <a name="M000014"></a>

        <div class="method-heading">
          <a href="#M000014" class="method-signature">
          <span class="method-name">read_path</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
The path from which the browser can read the image. It is by default a copy
of <tt>image_read_path</tt> on the model class.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000014-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000014-source">
<pre>
     <span class="ruby-comment cmt"># File lib/acts_as_image_active_record_extensions.rb, line 157</span>
157:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read_path</span>
158:           <span class="ruby-ivar">@read_path</span> <span class="ruby-operator">||=</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">image_read_path</span>.<span class="ruby-identifier">dup</span>
159:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000015" class="method-detail">
        <a name="M000015"></a>

        <div class="method-heading">
          <a href="#M000015" class="method-signature">
          <span class="method-name">read_path=</span><span class="method-args">(new_path)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000015-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000015-source">
<pre>
     <span class="ruby-comment cmt"># File lib/acts_as_image_active_record_extensions.rb, line 162</span>
162:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read_path=</span>(<span class="ruby-identifier">new_path</span>)
163:           <span class="ruby-ivar">@read_path</span> = <span class="ruby-identifier">new_path</span>
164:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000017" class="method-detail">
        <a name="M000017"></a>

        <div class="method-heading">
          <a href="#M000017" class="method-signature">
          <span class="method-name">read_path_with_filename</span><span class="method-args">(size = nil, ext = nil)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Adds a filename to <tt><a
href="InstanceMethods.html#M000016">read_path_with_own_path</a></tt>
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000017-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000017-source">
<pre>
     <span class="ruby-comment cmt"># File lib/acts_as_image_active_record_extensions.rb, line 174</span>
174:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read_path_with_filename</span>(<span class="ruby-identifier">size</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">ext</span> = <span class="ruby-keyword kw">nil</span>)
175:           <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">read_path_with_own_path</span>, <span class="ruby-identifier">filename</span>(<span class="ruby-identifier">size</span>, <span class="ruby-identifier">ext</span>))
176:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000016" class="method-detail">
        <a name="M000016"></a>

        <div class="method-heading">
          <a href="#M000016" class="method-signature">
          <span class="method-name">read_path_with_own_path</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Adds the image&#8217;s own <tt>path</tt> to the <tt><a
href="InstanceMethods.html#M000014">read_path</a></tt>
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000016-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000016-source">
<pre>
     <span class="ruby-comment cmt"># File lib/acts_as_image_active_record_extensions.rb, line 168</span>
168:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read_path_with_own_path</span>
169:           <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">read_path</span>, <span class="ruby-identifier">path</span>)
170:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000018" class="method-detail">
        <a name="M000018"></a>

        <div class="method-heading">
          <a href="#M000018" class="method-signature">
          <span class="method-name">save_path</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
The path in which the image&#8217;s directory structure will be written. It
is by default a copy of <tt>image_save_path</tt> on the image class.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000018-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000018-source">
<pre>
     <span class="ruby-comment cmt"># File lib/acts_as_image_active_record_extensions.rb, line 182</span>
182:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">save_path</span>
183:           <span class="ruby-ivar">@save_path</span> <span class="ruby-operator">||=</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">image_save_path</span>.<span class="ruby-identifier">dup</span>
184:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000019" class="method-detail">
        <a name="M000019"></a>

        <div class="method-heading">
          <a href="#M000019" class="method-signature">
          <span class="method-name">save_path=</span><span class="method-args">(new_path)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000019-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000019-source">
<pre>
     <span class="ruby-comment cmt"># File lib/acts_as_image_active_record_extensions.rb, line 187</span>
187:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">save_path=</span>(<span class="ruby-identifier">new_path</span>)
188:           <span class="ruby-ivar">@save_path</span> = <span class="ruby-identifier">new_path</span>
189:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000021" class="method-detail">
        <a name="M000021"></a>

        <div class="method-heading">
          <a href="#M000021" class="method-signature">
          <span class="method-name">save_path_with_filename</span><span class="method-args">(size = nil, ext = nil)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Adds a filename to <tt><a
href="InstanceMethods.html#M000020">save_path_with_own_path</a></tt>
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000021-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000021-source">
<pre>
     <span class="ruby-comment cmt"># File lib/acts_as_image_active_record_extensions.rb, line 199</span>
199:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">save_path_with_filename</span>(<span class="ruby-identifier">size</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">ext</span> = <span class="ruby-keyword kw">nil</span>)
200:           <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">save_path_with_own_path</span>, <span class="ruby-identifier">filename</span>(<span class="ruby-identifier">size</span>, <span class="ruby-identifier">ext</span>))
201:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000020" class="method-detail">
        <a name="M000020"></a>

        <div class="method-heading">
          <a href="#M000020" class="method-signature">
          <span class="method-name">save_path_with_own_path</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Adds the image&#8217;s own <tt>path</tt> to the &lt;tt&gt;<a
href="InstanceMethods.html#M000018">save_path</a>&lt;tt&gt;
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000020-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000020-source">
<pre>
     <span class="ruby-comment cmt"># File lib/acts_as_image_active_record_extensions.rb, line 193</span>
193:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">save_path_with_own_path</span>
194:           <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">save_path</span>, <span class="ruby-identifier">path</span>)
195:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000012" class="method-detail">
        <a name="M000012"></a>

        <div class="method-heading">
          <a href="#M000012" class="method-signature">
          <span class="method-name">sizes</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Contains the hash for the different names and sizes to be written. This is
by default a copy of <tt>image_sizes</tt> on the model class, but it can be
changed on a per-image basis. (An image won&#8217;t remember the sizes you
give it)
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000012-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000012-source">
<pre>
     <span class="ruby-comment cmt"># File lib/acts_as_image_active_record_extensions.rb, line 144</span>
144:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">sizes</span>
145:           <span class="ruby-ivar">@sizes</span> <span class="ruby-operator">||=</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">image_sizes</span>.<span class="ruby-identifier">dup</span>
146:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000013" class="method-detail">
        <a name="M000013"></a>

        <div class="method-heading">
          <a href="#M000013" class="method-signature">
          <span class="method-name">sizes=</span><span class="method-args">(new_sizes)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000013-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000013-source">
<pre>
     <span class="ruby-comment cmt"># File lib/acts_as_image_active_record_extensions.rb, line 149</span>
149:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">sizes=</span>(<span class="ruby-identifier">new_sizes</span>)
150:           <span class="ruby-ivar">@sizes</span> = <span class="ruby-identifier">new_sizes</span>
151:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000008" class="method-detail">
        <a name="M000008"></a>

        <div class="method-heading">
          <a href="#M000008" class="method-signature">
          <span class="method-name">url</span><span class="method-args">(size = nil, ext = nil)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Use this to get a URL to the image with the specific size that can be read
by the browser
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000008-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000008-source">
<pre>
     <span class="ruby-comment cmt"># File lib/acts_as_image_active_record_extensions.rb, line 106</span>
106:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">url</span>(<span class="ruby-identifier">size</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">ext</span> = <span class="ruby-keyword kw">nil</span>)
107:           <span class="ruby-value str">'/'</span><span class="ruby-operator">+</span><span class="ruby-identifier">read_path_with_filename</span>(<span class="ruby-identifier">size</span>, <span class="ruby-identifier">ext</span>)
108:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Private Instance methods</h3>

      <div id="method-M000024" class="method-detail">
        <a name="M000024"></a>

        <div class="method-heading">
          <a href="#M000024" class="method-signature">
          <span class="method-name">delete_files</span><span class="method-args">(</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Delete the image&#8217;s files from its <tt><a
href="InstanceMethods.html#M000020">save_path_with_own_path</a></tt>. This
method is called <tt>after_destroy</tt>.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000024-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000024-source">
<pre>
     <span class="ruby-comment cmt"># File lib/acts_as_image_active_record_extensions.rb, line 323</span>
323:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">delete_files</span><span class="ruby-comment cmt">#:doc:</span>
324:             <span class="ruby-identifier">sizes</span>.<span class="ruby-identifier">keys</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">size</span><span class="ruby-operator">|</span>
325:               <span class="ruby-constant">File</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">save_path</span>, <span class="ruby-identifier">filename</span>(<span class="ruby-identifier">size</span>)))
326:             <span class="ruby-keyword kw">end</span>
327:           <span class="ruby-keyword kw">rescue</span>
328:           <span class="ruby-keyword kw">ensure</span>
329:             <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
330:           <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000022" class="method-detail">
        <a name="M000022"></a>

        <div class="method-heading">
          <a href="#M000022" class="method-signature">
          <span class="method-name">generate_hash_string</span><span class="method-args">(</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Generates a hash to be used when creating the image&#8217;s directory
structure. This method is run <tt>before_validation</tt>, and
<tt>hash_string</tt> is validated to be unique.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000022-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000022-source">
<pre>
     <span class="ruby-comment cmt"># File lib/acts_as_image_active_record_extensions.rb, line 209</span>
209:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">generate_hash_string</span><span class="ruby-comment cmt">#:doc:</span>
210:             <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">hash_string</span>.<span class="ruby-identifier">nil?</span>
211:             <span class="ruby-keyword kw">begin</span>
212:               <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">hash_string</span> = <span class="ruby-constant">Digest</span><span class="ruby-operator">::</span><span class="ruby-constant">MD5</span>.<span class="ruby-identifier">hexdigest</span>(<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_f</span>.<span class="ruby-identifier">to_s</span>)
213:             <span class="ruby-keyword kw">end</span> <span class="ruby-keyword kw">while</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">find_by_hash_string</span>(<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">hash_string</span>)
214:           <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000023" class="method-detail">
        <a name="M000023"></a>

        <div class="method-heading">
          <a href="#M000023" class="method-signature">
          <span class="method-name">process_image</span><span class="method-args">(</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Scales and writes the image with the different names and sizes. The
<tt>file</tt> attribute can be a <tt>StringIO</tt> or <tt>Tempfile</tt>,
the two different types that can come from a form post, or a
<tt>Magick::ImageList</tt> from RMagick. The file can be omitted if the
record is not new, but is required in order for the record to be saved the
first time.
</p>
<p>
If for some reason the image can&#8217;t be written, the record will not be
saved and a message will be added to the record&#8217;s errors.
</p>
<p>
Make sure your server process has the rights to create directories at least
in the <tt><a href="InstanceMethods.html#M000018">save_path</a></tt>
directory. It will try to create <tt><a
href="InstanceMethods.html#M000018">save_path</a></tt> if it doesn&#8217;t
exist, but will fail if it doesn&#8217;t have the necessary rights.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000023-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000023-source">
<pre>
     <span class="ruby-comment cmt"># File lib/acts_as_image_active_record_extensions.rb, line 230</span>
230:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">process_image</span><span class="ruby-comment cmt">#:doc:</span>
231:             
232:             <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">file</span> <span class="ruby-operator">||</span> (<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">file</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:length</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">file</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>)
233:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">new_record?</span>
234:                 <span class="ruby-identifier">raise</span> <span class="ruby-value str">'No file.'</span>
235:               <span class="ruby-keyword kw">else</span>
236:                 <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
237:               <span class="ruby-keyword kw">end</span>
238:             <span class="ruby-keyword kw">end</span>
239:             
240:             <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">original_filename</span> = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">file</span>.<span class="ruby-identifier">original_filename</span> <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">file</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:original_filename</span>)
241:             
242:             <span class="ruby-keyword kw">unless</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">file</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Array</span>)
243:               <span class="ruby-comment cmt">#Read image data from form</span>
244:               <span class="ruby-keyword kw">begin</span>
245:                 <span class="ruby-identifier">original</span> = <span class="ruby-operator">::</span><span class="ruby-constant">Magick</span><span class="ruby-operator">::</span><span class="ruby-constant">ImageList</span>.<span class="ruby-identifier">new</span>.<span class="ruby-identifier">concat</span>(
246:                   <span class="ruby-operator">::</span><span class="ruby-constant">Magick</span><span class="ruby-operator">::</span><span class="ruby-constant">Image</span>.<span class="ruby-identifier">from_blob</span>(
247:                     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">file</span>.<span class="ruby-identifier">read</span>
248:                   ).<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">im</span><span class="ruby-operator">|</span>
249:                     <span class="ruby-identifier">im</span>.<span class="ruby-identifier">strip!</span>
250:                   }
251:                 )
252:               <span class="ruby-keyword kw">rescue</span>
253:                 <span class="ruby-identifier">raise</span> <span class="ruby-value str">'Could not read image. Are you sure this is an image file?'</span>
254:               <span class="ruby-keyword kw">end</span>
255:             <span class="ruby-keyword kw">else</span><span class="ruby-comment cmt">#Image is already a Magick::ImageList</span>
256:               <span class="ruby-identifier">original</span> = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">file</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-operator">::</span><span class="ruby-constant">Magick</span><span class="ruby-operator">::</span><span class="ruby-constant">ImageList</span>) <span class="ruby-operator">?</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">file</span> <span class="ruby-operator">:</span> <span class="ruby-operator">::</span><span class="ruby-constant">Magick</span><span class="ruby-operator">::</span><span class="ruby-constant">ImageList</span>.<span class="ruby-identifier">new</span>.<span class="ruby-identifier">concat</span>(<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">file</span>)
257:             <span class="ruby-keyword kw">end</span>
258:             
259:             <span class="ruby-comment cmt">#Scale/crop images</span>
260:             <span class="ruby-keyword kw">begin</span>
261:               <span class="ruby-comment cmt">#Will be a hash of [size, image] pairs, eg ['small', &lt;Magick::ImageList&gt;]</span>
262:               <span class="ruby-identifier">scaled_images</span> = <span class="ruby-identifier">sizes</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">name</span>,<span class="ruby-identifier">size</span><span class="ruby-operator">|</span>
263:               
264:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">size</span>.<span class="ruby-identifier">is_a?</span> <span class="ruby-constant">Array</span>
265:                   <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">size</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
266:                     <span class="ruby-identifier">method</span> = <span class="ruby-identifier">size</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">to_sym</span>
267:                     <span class="ruby-identifier">size</span> = <span class="ruby-identifier">size</span>[<span class="ruby-value">0</span>]
268:                   <span class="ruby-keyword kw">else</span>
269:                     <span class="ruby-identifier">method</span> = <span class="ruby-identifier">:scale</span>
270:                     <span class="ruby-identifier">size</span> = <span class="ruby-identifier">size</span>[<span class="ruby-value">0</span>]
271:                   <span class="ruby-keyword kw">end</span>
272:                 <span class="ruby-keyword kw">end</span>
273:                 
274:                 [
275:                   <span class="ruby-identifier">name</span>,
276:                   <span class="ruby-identifier">original</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">im</span><span class="ruby-operator">|</span>
277:                     <span class="ruby-identifier">im</span>.<span class="ruby-identifier">change_geometry</span>(<span class="ruby-identifier">size</span>){<span class="ruby-operator">|</span><span class="ruby-identifier">cols</span>,<span class="ruby-identifier">rows</span>,<span class="ruby-identifier">img</span><span class="ruby-operator">|</span>
278:                       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">method</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:crop</span>
279:                         <span class="ruby-identifier">img</span>.<span class="ruby-identifier">crop_resized</span>(<span class="ruby-identifier">cols</span>, <span class="ruby-identifier">rows</span>, <span class="ruby-operator">::</span><span class="ruby-constant">Magick</span><span class="ruby-operator">::</span><span class="ruby-constant">NorthWestGravity</span>)
280:                       <span class="ruby-keyword kw">else</span><span class="ruby-comment cmt"># method == :scale</span>
281:                         <span class="ruby-identifier">img</span>.<span class="ruby-identifier">resize</span>(<span class="ruby-identifier">cols</span>, <span class="ruby-identifier">rows</span>)
282:                       <span class="ruby-keyword kw">end</span>
283:                     }
284:                   }
285:                 ]
286:               }
287:             <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span>
288:               <span class="ruby-identifier">raise</span> <span class="ruby-value str">'Could not scale image.'</span>
289:             <span class="ruby-keyword kw">end</span>
290:             
291:             <span class="ruby-comment cmt">#Write scaled images to files</span>
292:             <span class="ruby-comment cmt">#Should possibly combine with scaling to consume less memory</span>
293:             <span class="ruby-keyword kw">begin</span>
294:               <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span>(<span class="ruby-identifier">save_path_with_own_path</span>)
295:               <span class="ruby-identifier">delete_files</span><span class="ruby-comment cmt">#Delete old files</span>
296:               <span class="ruby-identifier">scaled_images</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">pair</span><span class="ruby-operator">|</span>
297:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">pair</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span><span class="ruby-comment cmt">#Assume image is animated</span>
298:                   <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">content_type</span> = <span class="ruby-value str">'image/gif'</span>
299:                   <span class="ruby-identifier">pair</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">save_path_with_filename</span>(<span class="ruby-identifier">pair</span>.<span class="ruby-identifier">first</span>))
300:                 <span class="ruby-keyword kw">else</span>
301:                   <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">content_type</span> = <span class="ruby-value str">'image/jpeg'</span>
302:                   <span class="ruby-identifier">pair</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">save_path_with_filename</span>(<span class="ruby-identifier">pair</span>.<span class="ruby-identifier">first</span>))
303:                 <span class="ruby-keyword kw">end</span>
304:               }
305:             <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span>
306:               <span class="ruby-identifier">raise</span> <span class="ruby-value str">'Could not write image.'</span>
307:             <span class="ruby-keyword kw">end</span>
308:           <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
309:             <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-value str">'file'</span>, <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span>)
310:             <span class="ruby-identifier">delete_files</span>
311:             <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
312:           <span class="ruby-keyword kw">ensure</span>
313:             <span class="ruby-comment cmt">#Throw RMagick stuff out of memory</span>
314:             <span class="ruby-comment cmt">#TODO: Not sure this works the way I think</span>
315:             <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">file</span> = <span class="ruby-keyword kw">nil</span>
316:             <span class="ruby-identifier">scaled_images</span> = <span class="ruby-keyword kw">nil</span>
317:             <span class="ruby-constant">GC</span>.<span class="ruby-identifier">start</span>
318:           <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>